<!--https://stackoverflow.com/questions/31196114/draw-video-frame-by-frame-on-html5-canvas-and-control-with-slider-->
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Video</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;500&display=swap" rel="stylesheet">
    <script src='https://cdn.plot.ly/plotly-2.6.3.min.js'></script>
    <style>
        html,
        body {
            height: 100%;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-flow: center;
            background: #000;
            color: white;
            font-family: 'Montserrat', sans-serif;
        }

        video {
            width: 600px;
            height: 400px;
        }

        #header_videos {
            text-align: center;
            font-weight: 500;
        }
        #selector_header{
            font-weight: 200;
        }
        .divider{
            width: 1000px;
            height: 1px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.548);
        }
        buttonrow
        {
            display:inline;
        }
        #figures{
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            flex-flow: row wrap;
        }
    </style>
</head>

<body>
    <br>
    <div id='video_section'>
        <div id='figures'>
            <video>
                <source src="test1.webm" type="video/webm">
            </video>
            <div id='action_distr'></div>
        </div>
    </div>

    <br>
    <buttonrow>
        <button id="play_button" onclick="play()">Play</button>
        <button id="pause_button" onclick="pause()">Pause</button>
        <button id="reset_button" onclick="reset()">Reset</button>
        <button id="back_button" onclick="back()">Back</button>
        <button id="next_button" onclick="next()">Next</button>
    </buttonrow>

    <h3 id="selector_header">Timeline</h3>
        <input id='time_selector' type='range' min = 0 max = 100 step = 1>
        <div id='video_section'>
            <div id='figures'>
                <div id='value_func'></div>
                <div id='entropy_func'></div>
        </div>
    </div>

    <script type="text/javascript"> 
        const video_players = document.getElementsByTagName("video");
        const num_videos = video_players.length;
        const video_length = new Array(num_videos).fill(0);

        for (let i = 0; i < num_videos; i++) {
            video_players[i].addEventListener('timeupdate', timeListener);
            video_players[i].addEventListener('dblclick', function(e) {open_fullscreen(video_players[i]);});
        }

        const timeSelector = document.getElementById('time_selector');
        var tS_max_value = 0;
        var tS_step_size = 0;

        var y_values = [0.049078263342380524, 0.07062143087387085, 0.07990602403879166, 0.08553663641214371, 0.0896991714835167, 0.09440282732248306, 0.09827446937561035, 0.10120527446269989, 0.10343748331069946, 0.10515505075454712, 0.10662338137626648, 0.10780256986618042];
        var y_entropy = [0.6917833089828491, 0.6913810968399048, 0.6911962032318115, 0.691085696220398, 0.6910176277160645, 0.6909818649291992, 0.6909663677215576, 0.6909626126289368, 0.6909653544425964, 0.6909722089767456, 0.6909825205802917, 0.690995454788208];
        var y_action = [[0.5261072516441345, 0.4738927185535431], [0.5297073125839233, 0.47029271721839905], [0.531222939491272, 0.468777060508728], [0.5320941805839539, 0.4679058790206909],
        [0.5326194167137146, 0.4673805832862854], [0.5328922271728516, 0.46710777282714844], [0.5330098271369934, 0.466990202665329], [0.5330376625061035, 0.46696236729621887], [0.5330167412757874, 0.46698325872421265], [0.5329653024673462, 0.4670347273349762], [0.5328871607780457, 0.46711283922195435], [0.5327882766723633, 0.46721166372299194]];
        var action = [0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1];
        var action_names = ['move right', 'move left'];

        window.addEventListener('load', () => {
            for (let i = 0; i < num_videos; i++) {
                video_length[i] = video_players[i].duration;
                video_players[i].currentTime = 0.0001;
            }

            tS_max_value = video_length[0];
            tS_step_size = 1.;
            timeSelector.value = 0;
            timeSelector.setAttribute('max', tS_max_value);
            timeSelector.setAttribute('step', tS_step_size);
            update_plots(N);
        }, false)

        timeSelector.addEventListener('input', () => {
            time = video_length[0] / tS_max_value * timeSelector.value
            for (let i = 0; i < num_videos; i++) {
                video_players[i].currentTime = time
                if(video_players[i].currentTime == Math.round(video_players[i].currentTime))
                    video_players[i].currentTime += 0.0001
            }
            N = Math.round(video_players[0].currentTime);
        })

        function timeListener() {
            timeSelector.value = video_players[0].currentTime
            N = Math.round(video_players[0].currentTime);
            update_plots(N);
        }

        function pause() {
            for (let i = 0; i < num_videos; i++) {
                video_players[i].pause();
            }
        }

        function play() {
            for (let i = 0; i < num_videos; i++) {
                video_players[i].play();
            }
        }

        function reset() {
            for (let i = 0; i < num_videos; i++) {
                video_players[i].currentTime = 0.0001;
            }
            N = Math.round(video_players[0].currentTime);
            update_plots(N);
        }

        function back() {
            for (let i = 0; i < num_videos; i++) {
                video_players[i].currentTime = video_players[i].currentTime - tS_step_size
                if(video_players[i].currentTime == Math.round(video_players[i].currentTime))
                    video_players[i].currentTime += 0.0001
            }
            N = Math.round(video_players[0].currentTime);
            update_plots(N);
        }

        function next() {
            for (let i = 0; i < num_videos; i++) {
                video_players[i].currentTime = video_players[i].currentTime + tS_step_size;
                console.log(video_players[i].currentTime);
            }
            N = Math.round(video_players[0].currentTime);
            update_plots(N);
        }

        function open_fullscreen(vid_elem) {
            if (vid_elem.requestFullscreen) {
                vid_elem.requestFullscreen();
            } else if (vid_elem.webkitRequestFullscreen) { /* Safari */
                vid_elem.webkitRequestFullscreen();
            } else if (vid_elem.msRequestFullscreen) { /* IE11 */
                vid_elem.msRequestFullscreen();
            }
            vid_elem.pause();
        }

        function update_plots(N)  {
            set_scatter_line_plot('value_func', "Value Function", y_values, N);
            set_scatter_line_plot('entropy_func', "Entropy Function", y_entropy, N);
            set_bar_action_plot(y_action[N], action[N], action_names);
        }

        function set_bar_action_plot(y_values, action, action_names) {
            var bar_plot_layout_action = {
                autosize: true,
                width: 600,
                height: 360,
                margin: {
                    l: 20,
                    r: 0,
                    b: 30,
                    t: 20,
                    pad: 4
                  },
                plot_bgcolor: '#000',
                paper_bgcolor: '#000',
                font: {
                    family: 'Montserrat',
                    size: 12,
                    color: '#fff'
                },
                title: {
                    text: 'Action Distribution',
                    font: {
                        family: 'Montserrat',
                        size: 15,
                        color: '#fff'
                    }
                }
          };
            
            var color_value = new Array(y_values.length).fill('#FAEBD7');
            color_value[action] = '#FF0000';

            var bar_plot_data_action = [
                {
                    x: action_names,
                    y: y_values,
                    type: 'bar',
                    marker: {
                        color: color_value
                    },
                    textposition: 'auto',
                    text: y_values.map(String),
                    textfont: {
                        family: 'Montserrat',
                        size: 12,
                    },
                    textangle: 0,
                    textposition: 'bottom center',
                }
            ];

            Plotly.newPlot('action_distr', bar_plot_data_action, bar_plot_layout_action);
        }

        function set_scatter_line_plot(id, title, y_values, N) {
            var line__scatter_plot_layout_value = {
                autosize: true,
                width: 600,
                height: 360,
                margin: {
                    l: 20,
                    r: 0,
                    b: 30,
                    t: 20,
                    pad: 4
                    },
                plot_bgcolor: '#000',
                paper_bgcolor: '#000',
                font: {
                    family: 'Montserrat',
                    size: 12,
                    color: '#fff'
                },
                title: {
                    text: title,
                    font: {
                        family: 'Montserrat',
                        size: 15,
                        color: '#fff'
                    }
                },
                showlegend: false,
            };

            var x_values = [...Array(y_values.length).keys()].slice(1, y_values.length + 1);
            x_values.push(y_values.length);

            var x_values_marker = x_values.slice(0, N);
            var y_values_marker = y_values.slice(0, N);

            var line_scatter_plot_data_value = [
                {
                    x: [0].concat(x_values_marker),
                    y: [0].concat(y_values_marker),
                    mode: 'line',
                    line: {
                        color: '#FAEBD7'
                    },
                },
                {
                    x: [0].concat(x_values),
                    y: [0].concat(y_values),
                    mode: 'markers',
                    marker: {
                        color: '#FAEBD7'
                    },
                }
            ];

            Plotly.newPlot(id, line_scatter_plot_data_value, line__scatter_plot_layout_value);
        }
    </script>
</body>

</html>
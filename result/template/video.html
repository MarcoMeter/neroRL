<!--https://stackoverflow.com/questions/31196114/draw-video-frame-by-frame-on-html5-canvas-and-control-with-slider-->
<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Video</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;500&display=swap" rel="stylesheet">
    <script src='https://cdn.plot.ly/plotly-2.6.3.min.js'></script>
    <style>
        html,
        body {
            height: 100%;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-flow: center;
            background: #000;
            color: white;
            font-family: 'Montserrat', sans-serif;
        }

        video {
            width: 600px;
            height: 400px;
        }

        #header_videos {
            text-align: center;
            font-weight: 500;
        }
        #selector_header{
            font-weight: 200;
        }
        .divider{
            width: 1000px;
            height: 1px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.548);
        }
        buttonrow
        {
            display:inline;
        }
        #figures{
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            flex-flow: row wrap;
        }
    </style>
</head>

<body>
    <br>
    <div id='video_section'>
        <div id='figures'>
            <video id='video_player'>
                <source src="{{ videoName}}"type="video/webm">
            </video>
            <div id='action_distr'></div>
        </div>
    </div>

    <br>
    <buttonrow>
        <button id="play_button" onclick="play()">Play</button>
        <button id="pause_button" onclick="pause()">Pause</button>
        <button id="reset_button" onclick="reset()">Reset</button>
        <button id="back_button" onclick="back()">Back</button>
        <button id="next_button" onclick="next()">Next</button>
    </buttonrow>

    <h3 id="selector_header">Timeline</h3>
        <input id='time_selector' type='range' min = 0 max = 100 step = 1>
        <div id='video_section'>
            <div id='figures'>
                <div id='value_func'></div>
                <div id='entropy_func'></div>
        </div>
    </div>

    <script type="text/javascript"> 
        const video_player = document.getElementById("video_player");
        var video_length = 0;

        const timeSelector = document.getElementById('time_selector');
        var tS_max_value = 0;
        var tS_step_size = 0;

        var y_values = {{ yValues }};
        var y_entropy = {{ yEntropy }};
        var y_action = {{ yAction }};
        var action =  {{ action }};
        var action_names = {{ actionNames }};

        window.addEventListener('load', () => {
            video_length = video_player.duration - 0.9999;
            tS_max_value = video_length;
            tS_step_size = 1.;
            timeSelector.value = 0;
            timeSelector.setAttribute('max', tS_max_value);
            timeSelector.setAttribute('step', tS_step_size);

            video_player.addEventListener('timeupdate', timeListener);
            video_player.addEventListener('dblclick', function(e) {open_fullscreen(video_player);});
            reset();
        }, false)

        timeSelector.addEventListener('input', () => {
            time = video_length / tS_max_value * timeSelector.value
            video_player.currentTime = time
            if(video_player.currentTime == Math.round(video_player.currentTime))
                video_player.currentTime += 0.0001
            video_player.currentTime = Math.min(video_player.currentTime, video_length);
            update_plots();
        })

        function timeListener() {
            video_player.currentTime = Math.min(video_player.currentTime, video_length) + 0.0001;
            timeSelector.value = video_player.currentTime
            update_plots();
        }

        function pause() {
            video_player.pause();
        }

        function play() {
            video_player.play();
        }

        function reset() {
            video_player.currentTime = 0.0001;
            update_plots();
        }

        function back() {
            video_player.currentTime = video_player.currentTime - tS_step_size
            if(video_player.currentTime == Math.round(video_player.currentTime))
                video_player.currentTime += 0.0001
            update_plots();
        }

        function next() {
            video_player.currentTime = video_player.currentTime + tS_step_size;
            video_player.currentTime = Math.min(video_player.currentTime, video_length);
            update_plots();
        }

        function open_fullscreen(vid_elem) {
            if (vid_elem.requestFullscreen) {
                vid_elem.requestFullscreen();
            } else if (vid_elem.webkitRequestFullscreen) { /* Safari */
                vid_elem.webkitRequestFullscreen();
            } else if (vid_elem.msRequestFullscreen) { /* IE11 */
                vid_elem.msRequestFullscreen();
            }
            vid_elem.pause();
        }

        function update_plots()  {
            step = Math.round(video_player.currentTime);
            set_scatter_line_plot('value_func', "Value Function", y_values, step);
            set_scatter_line_plot('entropy_func', "Entropy Function", y_entropy, step);
            set_bar_action_plot(y_action[step], action[step], action_names);
        }

        function set_bar_action_plot(y_values, action, action_names) {
            var bar_plot_layout_action = {
                autosize: true,
                width: 600,
                height: 360,
                margin: {
                    l: 28,
                    r: 0,
                    b: 30,
                    t: 22,
                    pad: 4
                  },
                plot_bgcolor: '#000',
                paper_bgcolor: '#000',
                font: {
                    family: 'Montserrat',
                    size: 12,
                    color: '#fff'
                },
                title: {
                    text: 'Action Distribution',
                    font: {
                        family: 'Montserrat',
                        size: 15,
                        color: '#fff'
                    }
                }
          };
            
            var color_value = new Array(y_values.length).fill('#FAEBD7');
            color_value[action] = '#FF0000';

            var bar_plot_data_action = [
                {
                    x: action_names,
                    y: y_values,
                    type: 'bar',
                    marker: {
                        color: color_value
                    },
                    textposition: 'auto',
                    text: y_values.map(String),
                    textfont: {
                        family: 'Montserrat',
                        size: 12,
                    },
                    textangle: 0,
                    textposition: 'bottom center',
                }
            ];

            Plotly.newPlot('action_distr', bar_plot_data_action, bar_plot_layout_action);
        }

        function set_scatter_line_plot(id, title, y_values, N) {
            var line__scatter_plot_layout_value = {
                autosize: true,
                width: 600,
                height: 360,
                margin: {
                    l: 50,
                    r: 0,
                    b: 30,
                    t: 25,
                    pad: 4
                    },
                yaxis: {
                    automargin: true
                },
                plot_bgcolor: '#000',
                paper_bgcolor: '#000',
                font: {
                    family: 'Montserrat',
                    size: 12,
                    color: '#fff'
                },
                title: {
                    text: title,
                    font: {
                        family: 'Montserrat',
                        size: 15,
                        color: '#fff'
                    }
                },
                showlegend: false,
            };

            var x_values = [...Array(y_values.length).keys()];

            var x_values_marker = x_values.slice(0, N + 1);
            var y_values_marker = y_values.slice(0, N + 1);

            var line_scatter_plot_data_value = [
                {
                    x: x_values_marker,
                    y: y_values_marker,
                    mode: 'line',
                    line: {
                        color: '#FAEBD7'
                    },
                },
                {
                    x: x_values,
                    y: y_values,
                    mode: 'markers',
                    marker: {
                        color: '#7CFC00'
                    },
                }
            ];

            Plotly.newPlot(id, line_scatter_plot_data_value, line__scatter_plot_layout_value);
        }
    </script>
</body>

</html>